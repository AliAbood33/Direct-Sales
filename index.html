document.getElementById('purchaseForm').addEventListener('submit', async function(event) {
    event.preventDefault();
    
    const timestamp = new Date().toLocaleString('ar-EG');
    document.getElementById('timestamp').value = timestamp;

    const storeName = document.getElementById("storeName").value;
    const representativeName = document.getElementById("representativeName").value;

    // تجميع أسماء الأطباء
    let doctorNames = [];
    document.querySelectorAll('input[name="doctorName[]"]').forEach(doctor => {
        doctorNames.push(doctor.value);
    });
    const doctorsList = doctorNames.join(", ");

    const productItems = document.querySelectorAll('.product-item');

    let formData = new FormData();
    formData.append("storeName", storeName);
    formData.append("representativeName", representativeName);
    formData.append("timestamp", timestamp);
    formData.append("doctorNames", doctorsList);

    productItems.forEach((item, index) => {
        let productType = item.querySelector('select[name="type[]"]').value;
        let quantity = item.querySelector('input[name="quantity[]"]').value;

        formData.append(`type[]`, productType);
        formData.append(`quantity[]`, quantity);
    });

    // رفع الصور باستخدام FileReader
    const images = document.getElementById("image").files;
    for (let img of images) {
        formData.append("image[]", img, img.name);
    }

    try {
        const response = await fetch('YOUR_GOOGLE_APPS_SCRIPT_URL', {
            method: 'POST',
            body: formData
        });

        const result = await response.text();
        
        if (result.includes("Success")) {
            const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
            alert(`تم إرسال البيانات بنجاح!\n\n${randomMessage}\n\nتحياتي،\nعلي عبود`);
            document.getElementById('purchaseForm').reset();
        } else {
            alert(`⚠ حدث خطأ أثناء الإرسال: ${result}`);
        }
    } catch (error) {
        alert(`❌ خطأ في الاتصال: ${error.message}`);
    }
});
